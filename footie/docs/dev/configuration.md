# Configuration

This document describes all configuration options available in WFCS Football and how to set up your development and production environments.

## Configuration Files

### config/app.php

Application-level settings.

```php
<?php
return [
    // Application name shown in browser title and header
    'name' => 'WFCS Football',

    // Admin password hash loaded from environment
    'admin_password_hash' => getenv('ADMIN_PASSWORD_HASH') ?: '',

    // Path where data files are stored (currently unused - MySQL used instead)
    'data_path' => dirname(__DIR__) . '/data',

    // Debug mode - shows detailed errors
    // IMPORTANT: Set to false in production
    'debug' => filter_var(
        getenv('APP_DEBUG') !== false ? getenv('APP_DEBUG') : 'true',
        FILTER_VALIDATE_BOOLEAN
    ),
];
```

**Settings**:

| Setting | Type | Default | Description |
|---------|------|---------|-------------|
| name | string | "WFCS Football" | Application name |
| admin_password_hash | string | "" | Bcrypt hash from .env |
| data_path | string | ./data | Data directory path |
| debug | bool | true | Debug mode (show errors) |

---

### config/database.php

Database connection settings.

```php
<?php
return [
    // Database name
    'database' => 'wfcs',

    // MySQL user (embedded MySQL uses root)
    'username' => 'root',

    // MySQL password (empty for embedded)
    'password' => '',

    // Unix socket path for Galvani's embedded MySQL
    // Goes up 1 level from footie/ to reach data/mysql.sock
    'socket' => dirname(__DIR__) . '/../data/mysql.sock',

    // PDO options
    'options' => [
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
        PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
        PDO::ATTR_EMULATE_PREPARES => true,
    ],
];
```

**Settings**:

| Setting | Type | Default | Description |
|---------|------|---------|-------------|
| database | string | "wfcs" | Database name |
| username | string | "root" | MySQL username |
| password | string | "" | MySQL password |
| socket | string | ../data/mysql.sock | Unix socket path |
| options | array | [...] | PDO connection options |

**PDO Options**:
- `ATTR_ERRMODE`: EXCEPTION - Throws exceptions on errors
- `ATTR_DEFAULT_FETCH_MODE`: ASSOC - Fetch associative arrays
- `ATTR_EMULATE_PREPARES`: true - Required for correct DATE/TIME handling

---

### config/routes.php

Route definitions. See [api.md](api.md) for details.

```php
<?php
use Core\Router;

$router = new Router();

// Public routes (protected: false)
$router->get('/', 'PublicController', 'index', false);
$router->get('/leagues', 'PublicController', 'leagues', false);

// Admin routes (protected: true by default)
$router->get('/admin', 'DashboardController', 'index');
$router->get('/admin/teams', 'TeamsController', 'index');

return $router;
```

**Route Format**:
```php
$router->method($path, $controller, $action, $protected = true);
```

---

## Environment Variables

Configuration via `.env` file in the `footie/` directory.

### .env File

```bash
# Galvani Configuration
GALVANI_MDNS=galvani
GALVANI_MYSQL=1

# Debug Mode
# Set to 'false' in production to hide error messages
APP_DEBUG=false

# Admin Password Hash
# Generated by generate_password.php or footie-install.php
ADMIN_PASSWORD_HASH=$2y$12$oVvcg8lsk/iSKjLieMvfTuq4W6yU3GzOqmHQjqO1jP/Fp9RJ9IBLG
```

### Environment Variables Reference

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| GALVANI_MDNS | No | - | mDNS name for Galvani |
| GALVANI_MYSQL | No | 0 | Enable embedded MySQL (1=on, 0=off) |
| APP_DEBUG | No | true | Debug mode (true/false) |
| ADMIN_PASSWORD_HASH | Yes | - | Bcrypt hash of admin password |

### Generating Password Hash

#### Option 1: Installation Script

```bash
./galvani footie-install.php --admin-password=YourPassword
```

The installer generates the hash and saves it to `.env`.

#### Option 2: Generate Password Script

At the root level (not in footie/):

```bash
php generate_password.php
```

Enter your password when prompted, then copy the hash to `.env`:

```bash
ADMIN_PASSWORD_HASH=$2y$12$...
```

#### Option 3: PHP CLI

```bash
php -r "echo password_hash('YourPassword', PASSWORD_BCRYPT, ['cost' => 12]);"
```

---

## Session Configuration

Sessions configured in `index.php`:

```php
// Force specific session name to avoid conflicts
session_name('FOOTIE_SESSION');

// Security settings
ini_set('session.cookie_httponly', '1');  // Prevent XSS
ini_set('session.use_only_cookies', '1'); // No URL sessions
ini_set('session.use_strict_mode', '1');  // Reject uninitialized IDs
ini_set('session.cookie_samesite', 'Strict'); // CSRF protection

// Enable secure flag for HTTPS
if (!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off') {
    ini_set('session.cookie_secure', '1');
}

// Session timeout: 2 hours of inactivity
ini_set('session.gc_maxlifetime', '7200');
ini_set('session.cookie_lifetime', '7200');
```

**Session Settings**:

| Setting | Value | Description |
|---------|-------|-------------|
| session.name | FOOTIE_SESSION | Unique session name |
| session.cookie_httponly | 1 | Block JavaScript access |
| session.use_only_cookies | 1 | No URL-based sessions |
| session.use_strict_mode | 1 | Reject invalid session IDs |
| session.cookie_samesite | Strict | CSRF protection |
| session.cookie_secure | 1 (HTTPS only) | Secure flag for HTTPS |
| session.gc_maxlifetime | 7200 | 2-hour timeout |
| session.cookie_lifetime | 7200 | 2-hour cookie lifetime |

---

## Error Handling

Error configuration in `index.php`:

```php
if ($config['debug']) {
    // Development: Show all errors
    error_reporting(E_ALL);
    ini_set('display_errors', '1');
} else {
    // Production: Hide errors
    error_reporting(0);
    ini_set('display_errors', '0');
}
```

**Debug Mode (APP_DEBUG=true)**:
- Display all PHP errors
- Show detailed error messages
- Display debug info in 404 pages
- Verbose exception traces

**Production Mode (APP_DEBUG=false)**:
- Hide all PHP errors from users
- Show generic error messages
- Log errors (via Galvani logger)
- Minimal 404 pages

---

## Galvani Configuration

WFCS Football runs on Galvani with these settings:

### Server Settings

```bash
# Start server
./galvani --server :8080 --document-root .

# With more threads
./galvani --server :8080 --threads 16

# With explicit config
./galvani --server :8080 \
          --document-root . \
          --threads 8 \
          --ini-set galvani.http_timeout=60
```

**Key Galvani Settings**:

| Flag | Default | Description |
|------|---------|-------------|
| --server | :8080 | Server address and port |
| --document-root | . | Document root directory |
| --threads | CPU×2 | Thread pool size |
| --ini-set | - | Set INI values |

### Recommended Galvani INI Settings

```bash
# HTTP settings
galvani.http_timeout=30          # Request timeout (seconds)
galvani.http_keepalive=15        # Keep-alive timeout
galvani.http_max_connections=0   # Unlimited connections

# Static file serving
galvani.static=1                 # Enable static files
galvani.static_cache_control="public, max-age=31536000, immutable"

# Worker settings (not currently used by footie)
galvani.worker_timeout=0         # Worker timeout
galvani.worker_queue_size=1000   # Deferred job queue size
```

---

## Tailwind CSS Configuration

### tailwind.config.js

Located at the root level (not in footie/):

```javascript
module.exports = {
  content: [
    './footie/**/*.php'
  ],
  theme: {
    extend: {},
  },
  plugins: [],
}
```

### CSS Input

`footie/css/input.css`:

```css
@tailwind base;
@tailwind components;
@tailwind utilities;

/* Custom styles */
```

### CSS Output

`footie/css/output.css` - Generated by Tailwind CLI

### Compilation

Development (watch mode):
```bash
npx tailwindcss -i footie/css/input.css -o footie/css/output.css --watch
```

Production (minified):
```bash
npx tailwindcss -i footie/css/input.css -o footie/css/output.css --minify
```

---

## Autoloader Configuration

Autoloader in `index.php`:

```php
spl_autoload_register(function (string $class): void {
    $namespaces = [
        'Core\\' => 'core/',
        'App\\Controllers\\' => 'app/Controllers/',
        'App\\Models\\' => 'app/Models/',
    ];

    foreach ($namespaces as $namespace => $dir) {
        if (str_starts_with($class, $namespace)) {
            $relativeClass = substr($class, strlen($namespace));
            $file = BASE_PATH . '/' . $dir . str_replace('\\', '/', $relativeClass) . '.php';

            if (file_exists($file)) {
                require $file;
                return;
            }
        }
    }
});
```

**Namespace Mappings**:
- `Core\*` → `footie/core/*.php`
- `App\Controllers\*` → `footie/app/Controllers/*.php`
- `App\Models\*` → `footie/app/Models/*.php`

---

## Development Environment Setup

### Prerequisites

- Galvani binary
- Node.js (for Tailwind CSS)

### Setup Steps

1. **Install application**:
   ```bash
   ./galvani footie-install.php
   ```

2. **Configure environment**:
   ```bash
   cd footie
   nano .env
   ```

   Set `APP_DEBUG=true` for development.

3. **Start Tailwind watcher** (in separate terminal):
   ```bash
   npx tailwindcss -i footie/css/input.css -o footie/css/output.css --watch
   ```

4. **Start Galvani server**:
   ```bash
   ./galvani --server :8080
   ```

5. **Access application**:
   - Public: http://localhost:8080/footie/
   - Admin: http://localhost:8080/footie/login

### Development Tools

**Run tests**:
```bash
./galvani footie/tests/run_tests.php
```

**View logs**:
Galvani logs to stdout. Redirect to file:
```bash
./galvani --server :8080 > galvani.log 2>&1
```

**Database access**:
Use Galvani MCP tools or connect via socket:
```bash
mysql -S data/mysql.sock -u root wfcs
```

---

## Production Environment Setup

### Prerequisites

- Galvani binary
- Compiled CSS (output.css)

### Setup Steps

1. **Install application**:
   ```bash
   ./galvani footie-install.php --admin-password=SecurePassword --load-sample=n
   ```

2. **Configure for production**:
   ```bash
   cd footie
   nano .env
   ```

   Set:
   ```bash
   APP_DEBUG=false
   ADMIN_PASSWORD_HASH=<your_secure_hash>
   ```

3. **Compile CSS for production**:
   ```bash
   npx tailwindcss -i footie/css/input.css -o footie/css/output.css --minify
   ```

4. **Start server as daemon**:
   ```bash
   nohup ./galvani --server :8080 > galvani.log 2>&1 &
   ```

5. **Set up reverse proxy** (optional):
   Use nginx or Apache to proxy to Galvani on :8080

### Production Checklist

- [ ] `APP_DEBUG=false` in `.env`
- [ ] Strong admin password set
- [ ] CSS compiled and minified
- [ ] Sample data removed (or desired data loaded)
- [ ] Server logs configured
- [ ] Firewall rules configured
- [ ] HTTPS configured (via reverse proxy)
- [ ] Regular backups configured
- [ ] Session cookies secure (HTTPS)

---

## Subdirectory Installation

WFCS Football automatically handles subdirectory installations.

### Example: Installing in /sports/

1. Install to subdirectory:
   ```bash
   ./galvani footie-install.php --app-dir=sports
   ```

2. Access application:
   - Public: http://localhost:8080/sports/
   - Admin: http://localhost:8080/sports/login

**How it works**:
- Router normalizes URIs based on SCRIPT_NAME
- Controllers adjust redirects to include base path
- Views receive `$basePath` variable for links
- No configuration needed - automatic detection

---

## Troubleshooting

### Debug Mode Not Working

Check `.env` file exists and has:
```bash
APP_DEBUG=true
```

Verify in code:
```php
$config = require BASE_PATH . '/config/app.php';
var_dump($config['debug']); // Should be true
```

### Database Connection Fails

Check:
1. Galvani started with `GALVANI_MYSQL=1` in `.env`
2. Socket path correct in `config/database.php`
3. Socket file exists: `ls ../data/mysql.sock`
4. Database created: `SHOW DATABASES LIKE 'wfcs'`

### Sessions Not Working

Check:
1. Session directory writable
2. No output before `session_start()`
3. Cookies enabled in browser
4. Session name unique (FOOTIE_SESSION)

### Styles Not Applying

Check:
1. CSS compiled: `ls -lh footie/css/output.css`
2. File not empty
3. Tailwind watching correct paths
4. Browser cache cleared

### Routes Not Found

Check:
1. `.htaccess` not used (Galvani doesn't need it)
2. Router debug mode enabled to see URI normalization
3. Route defined in `config/routes.php`
4. Controller and method exist

---

## Configuration Best Practices

1. **Never commit .env to version control**
   - Add to .gitignore
   - Use .env.example as template

2. **Use strong passwords**
   - Minimum 12 characters
   - Mix of letters, numbers, symbols
   - Use password manager

3. **Debug mode off in production**
   - Prevents information disclosure
   - Improves performance
   - Better user experience

4. **Regular backups**
   - Database: `mysqldump`
   - Application files
   - .env file (securely)

5. **Monitor logs**
   - Check for errors
   - Watch for suspicious activity
   - Rotate logs regularly

6. **Keep Galvani updated**
   - Latest security patches
   - Performance improvements
   - Bug fixes

7. **Use HTTPS in production**
   - Protects passwords
   - Protects session cookies
   - Required for secure flag

---

## Environment-Specific Configs

### Local Development

```bash
APP_DEBUG=true
ADMIN_PASSWORD_HASH=$2y$12$...  # Simple password OK
```

### Staging

```bash
APP_DEBUG=true  # Show errors for testing
ADMIN_PASSWORD_HASH=$2y$12$...  # Strong password
```

### Production

```bash
APP_DEBUG=false  # Hide errors
ADMIN_PASSWORD_HASH=$2y$12$...  # Very strong password
```

---

## Custom Configuration

To add new config options:

1. **Add to config file**:
   ```php
   // config/app.php
   'my_setting' => getenv('MY_SETTING') ?: 'default',
   ```

2. **Add to .env**:
   ```bash
   MY_SETTING=value
   ```

3. **Access in code**:
   ```php
   $config = require BASE_PATH . '/config/app.php';
   $value = $config['my_setting'];
   ```

---

## Configuration Validation

Add validation in `index.php`:

```php
// Validate required config
if (empty($config['admin_password_hash'])) {
    die('Error: ADMIN_PASSWORD_HASH not set in .env');
}

// Validate password hash format
if (!str_starts_with($config['admin_password_hash'], '$2y$')) {
    die('Error: Invalid password hash format');
}

// Warn about debug mode in production
if ($config['debug'] && getenv('PRODUCTION') === 'true') {
    error_log('WARNING: Debug mode enabled in production');
}
```

---

## Summary

Key configuration points:
- `.env` for environment-specific settings
- `config/` for application settings
- `APP_DEBUG` controls error display
- Sessions configured for security
- Galvani settings via CLI flags
- Tailwind compiled separately
- Subdirectory support automatic

For more information:
- See [architecture.md](architecture.md) for system design
- See [api.md](api.md) for route configuration
- See Galvani CLAUDE.md for runtime options
